<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vinyl Collection Manager</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ðŸŽµ Vinyl Collection Manager</h1>
        <p>Manage your vinyl record collection</p>
      </header>

      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('browse')">
          Browse Records
        </button>
        <button class="tab-btn" onclick="showTab('add')">Add Vinyl</button>
        <button class="tab-btn" onclick="showTab('statistics')">
          Statistics
        </button>
      </div>

      <!-- Browse Tab -->
      <div id="browse-tab" class="tab-content active">
        <h2>My Vinyl Collection</h2>

        <div class="filters">
          <input
            type="text"
            id="searchInput"
            placeholder="Search by title or artist..."
          />
          <select id="genreFilter">
            <option value="">All Genres</option>
          </select>
          <select id="sortBy">
            <option value="createdAt">Sort by Date Added</option>
            <option value="title">Sort by Title</option>
            <option value="artist">Sort by Artist</option>
            <option value="year">Sort by Year</option>
          </select>
          <select id="sortOrder">
            <option value="desc">Descending</option>
            <option value="asc">Ascending</option>
          </select>
          <button onclick="applyFilters()">Apply Filters</button>
        </div>

        <div id="vinylsContainer" class="vinyl-grid"></div>
      </div>

      <!-- Add Vinyl Tab -->
      <div id="add-tab" class="tab-content">
        <h2>Add New Vinyl</h2>
        <div id="addMessage"></div>
        <form id="addVinylForm">
          <div class="form-group">
            <label>Title *</label>
            <input type="text" name="title" required />
          </div>
          <div class="form-group">
            <label>Artist *</label>
            <input type="text" name="artist" required />
          </div>
          <div class="form-group">
            <label>Year</label>
            <input type="number" name="year" min="1900" max="2025" />
          </div>
          <div class="form-group">
            <label>Label</label>
            <input type="text" name="label" />
          </div>
          <div class="form-group">
            <label>Genre</label>
            <input type="text" name="genre" />
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea name="description"></textarea>
          </div>

          <div class="tracks-section">
            <h3>Tracks</h3>
            <div id="tracksContainer"></div>
            <button type="button" onclick="addTrackInput()" class="secondary">
              + Add Track
            </button>
          </div>

          <button type="submit" style="margin-top: 20px;">Add Vinyl</button>
        </form>
      </div>

      <!-- Statistics Tab -->
      <div id="statistics-tab" class="tab-content">
        <h2>Collection Statistics</h2>
        <div id="statsContainer"></div>
      </div>
    </div>

    <!-- View/Edit Modal -->
    <div id="vinylModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle"></h2>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalBody"></div>
      </div>
    </div>

    <script>
      const API_URL = "/vinyls";
      let currentVinyls = [];

      // Tab Management
      function showTab(tabName) {
        document
          .querySelectorAll(".tab-content")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));

        document.getElementById(`${tabName}-tab`).classList.add("active");
        event.target.classList.add("active");

        if (tabName === "browse") loadVinyls();
        if (tabName === "statistics") loadStatistics();
      }

      // Load all vinyls
      async function loadVinyls(filters = {}) {
        console.log("zww");
        const container = document.getElementById("vinylsContainer");
        container.innerHTML = '<div class="loading">Loading vinyls...</div>';

        try {
          const queryParams = new URLSearchParams(filters);
          const response = await fetch(`${API_URL}?${queryParams}`);
          currentVinyls = await response.json();

          if (currentVinyls.length === 0) {
            container.innerHTML =
              "<p>No vinyls found. Add your first vinyl!</p>";
            return;
          }

          container.innerHTML = currentVinyls
            .map(
              (vinyl) => `
                <div class="vinyl-card" onclick="viewVinyl('${vinyl.id}')">
                    <h3>${vinyl.title}</h3>
                    <p><strong>${vinyl.artist}</strong></p>
                    ${vinyl.year ? `<p>Released: ${vinyl.year}</p>` : ""}
                    ${vinyl.genre ? `<p>Genre: ${vinyl.genre}</p>` : ""}
                    ${vinyl.label ? `<p>Label: ${vinyl.label}</p>` : ""}
                    <p>${vinyl.tracks.length} tracks</p>
                    <div class="actions">
                        <button onclick="event.stopPropagation(); editVinyl('${
                          vinyl.id
                        }')" class="secondary">Edit</button>
                        <button onclick="event.stopPropagation(); deleteVinyl('${
                          vinyl.id
                        }')" class="danger">Delete</button>
                    </div>
                </div>
            `
            )
            .join("");

          // Populate genre filter
          const genres = [
            ...new Set(currentVinyls.map((v) => v.genre).filter(Boolean)),
          ];
          const genreFilter = document.getElementById("genreFilter");
          genreFilter.innerHTML =
            '<option value="">All Genres</option>' +
            genres.map((g) => `<option value="${g}">${g}</option>`).join("");
        } catch (error) {
          container.innerHTML =
            "<p>Error loading vinyls. Please try again.</p>";
          console.error("Error:", error);
        }
      }

      // Apply filters
      function applyFilters() {
        const filters = {
          search: document.getElementById("searchInput").value,
          genre: document.getElementById("genreFilter").value,
          sortBy: document.getElementById("sortBy").value,
          order: document.getElementById("sortOrder").value,
        };

        // Remove empty filters
        Object.keys(filters).forEach(
          (key) => !filters[key] && delete filters[key]
        );

        loadVinyls(filters);
      }

      // Add track input
      let trackCount = 0;
      function addTrackInput() {
        trackCount++;
        const container = document.getElementById("tracksContainer");
        const trackDiv = document.createElement("div");
        trackDiv.className = "track-inputs";
        trackDiv.innerHTML = `
            <input type="text" placeholder="Track name" name="track_name_${trackCount}" required>
            <input type="text" placeholder="Duration (MM:SS)" name="track_duration_${trackCount}" pattern="\\d{1,2}:\\d{2}" required>
            <input type="text" placeholder="Side (A1, B2, etc)" name="track_side_${trackCount}" pattern="[AB]\\d{1,2}" required>
            <button type="button" onclick="this.parentElement.remove()" class="danger">Remove</button>
        `;
        container.appendChild(trackDiv);
      }

      // Add vinyl form submission
      document
        .getElementById("addVinylForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);

          const data = {
            title: formData.get("title"),
            artist: formData.get("artist"),
            year: formData.get("year") ? parseInt(formData.get("year")) : null,
            label: formData.get("label") || null,
            genre: formData.get("genre") || null,
            description: formData.get("description") || null,
            tracks: [],
          };

          // Collect tracks
          for (let i = 1; i <= trackCount; i++) {
            const name = formData.get(`track_name_${i}`);
            if (name) {
              data.tracks.push({
                name,
                duration: formData.get(`track_duration_${i}`),
                side: formData.get(`track_side_${i}`),
              });
            }
          }

          try {
            const response = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              showMessage("addMessage", "Vinyl added successfully!", "success");
              e.target.reset();
              document.getElementById("tracksContainer").innerHTML = "";
              trackCount = 0;
              setTimeout(() => {
                showTab("browse");
                document.querySelector(".tab-btn").click();
              }, 1500);
            } else {
              const error = await response.json();
              showMessage(
                "addMessage",
                error.message || "Error adding vinyl",
                "error"
              );
            }
          } catch (error) {
            showMessage(
              "addMessage",
              "Error adding vinyl. Please try again.",
              "error"
            );
            console.error("Error:", error);
          }
        });

      // View vinyl details
      async function viewVinyl(id) {
        try {
          const response = await fetch(`${API_URL}/${id}`);
          const vinyl = await response.json();

          document.getElementById("modalTitle").textContent = vinyl.title;
          document.getElementById("modalBody").innerHTML = `
                <p><strong>Artist:</strong> ${vinyl.artist}</p>
                ${
                  vinyl.year
                    ? `<p><strong>Year:</strong> ${vinyl.year}</p>`
                    : ""
                }
                ${
                  vinyl.label
                    ? `<p><strong>Label:</strong> ${vinyl.label}</p>`
                    : ""
                }
                ${
                  vinyl.genre
                    ? `<p><strong>Genre:</strong> ${vinyl.genre}</p>`
                    : ""
                }
                ${
                  vinyl.description
                    ? `<p><strong>Description:</strong> ${vinyl.description}</p>`
                    : ""
                }
                
                <h3 style="margin-top: 20px;">Tracklist</h3>
                ${vinyl.tracks
                  .map(
                    (track) => `
                    <div class="track-item">
                        <span>${track.side}. ${track.name}</span>
                        <span>${track.duration}</span>
                    </div>
                `
                  )
                  .join("")}
            `;

          document.getElementById("vinylModal").style.display = "block";
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // Edit vinyl
      function editVinyl(id) {
        alert(
          "Edit functionality - Coming soon!\nFor now, you can delete and recreate the record."
        );
      }

      // Delete vinyl
      async function deleteVinyl(id) {
        if (!confirm("Are you sure you want to delete this vinyl?")) return;

        try {
          const response = await fetch(`${API_URL}/${id}`, {
            method: "DELETE",
          });

          if (response.ok) {
            loadVinyls();
          } else {
            alert("Error deleting vinyl");
          }
        } catch (error) {
          alert("Error deleting vinyl. Please try again.");
          console.error("Error:", error);
        }
      }

      // Load statistics
      async function loadStatistics() {
        const container = document.getElementById("statsContainer");
        container.innerHTML =
          '<div class="loading">Loading statistics...</div>';

        try {
          const response = await fetch(`${API_URL}/statistics`);
          const stats = await response.json();

          container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${stats.totalVinyls}</h3>
                        <p>Total Vinyls</p>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Vinyls by Genre</h3>
                <div class="stats-grid">
                    ${stats.vinylsByGenre
                      .map(
                        (item) => `
                        <div class="stat-card">
                            <h3>${item.count}</h3>
                            <p>${item.genre}</p>
                        </div>
                    `
                      )
                      .join("")}
                </div>

                <h3 style="margin-top: 30px;">Vinyls by Year</h3>
                <div class="stats-grid">
                    ${stats.vinylsByYear
                      .slice(0, 10)
                      .map(
                        (item) => `
                        <div class="stat-card">
                            <h3>${item.count}</h3>
                            <p>${item.year}</p>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;
        } catch (error) {
          container.innerHTML = "<p>Error loading statistics.</p>";
          console.error("Error:", error);
        }
      }

      // Close modal
      function closeModal() {
        document.getElementById("vinylModal").style.display = "none";
      }

      // Show message
      function showMessage(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => (element.innerHTML = ""), 3000);
      }

      // Load vinyls on page load
      loadVinyls();
    </script>
  </body>
</html>
